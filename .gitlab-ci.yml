# GitLab CI/CD Pipeline for Economic Toolkit v2.0
# 6 stages: lint, test, build, security, deploy, release

stages:
  - lint
  - test
  - build
  - security
  - deploy
  - release

variables:
  JULIA_VERSION: "1.10"
  NODE_VERSION: "20"
  PODMAN_VERSION: "4.0"

# Cache dependencies
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/
    - .julia/

# ===== LINT STAGE =====

lint:julia:
  stage: lint
  image: julia:${JULIA_VERSION}
  script:
    - julia --project=. -e 'using Pkg; Pkg.add("JuliaFormatter"); using JuliaFormatter'
    - julia --project=. -e 'using JuliaFormatter; format("src/julia", verbose=true, overwrite=false) || exit(1)'
  only:
    - merge_requests
    - main
    - develop

lint:typescript:
  stage: lint
  image: node:${NODE_VERSION}
  script:
    - npm ci
    - npm run lint
  only:
    - merge_requests
    - main
    - develop

lint:prettier:
  stage: lint
  image: node:${NODE_VERSION}
  script:
    - npm ci
    - npx prettier --check "src/**/*.{ts,tsx,js,jsx}"
  only:
    - merge_requests
    - main
    - develop

# ===== TEST STAGE =====

test:julia:
  stage: test
  image: julia:${JULIA_VERSION}
  script:
    - julia --project=. -e 'using Pkg; Pkg.instantiate()'
    - julia --project=. -e 'using Pkg; Pkg.test(coverage=true)'
  coverage: '/Test coverage (\d+\.\d+%)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
  only:
    - merge_requests
    - main
    - develop

test:typescript:
  stage: test
  image: node:${NODE_VERSION}
  script:
    - npm ci
    - npm run test:coverage
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    reports:
      junit: junit.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
  only:
    - merge_requests
    - main
    - develop

test:integration:
  stage: test
  image: node:${NODE_VERSION}
  services:
    - julia:${JULIA_VERSION}
  script:
    - npm ci
    - julia --project=. -e 'using Pkg; Pkg.instantiate()'
    - julia --project=. src/julia/EconomicToolkit.jl --dev &
    - sleep 10  # Wait for server to start
    - npm run test:integration
  only:
    - merge_requests
    - main
    - develop

# ===== BUILD STAGE =====

build:typescript:
  stage: build
  image: node:${NODE_VERSION}
  script:
    - npm ci
    - npm run build
  artifacts:
    paths:
      - dist/
    expire_in: 1 week
  only:
    - main
    - develop
    - tags

build:julia:
  stage: build
  image: julia:${JULIA_VERSION}
  script:
    - julia --project=. -e 'using Pkg; Pkg.instantiate()'
    - julia --project=. -e 'using PackageCompiler; create_sysimage(:EconomicToolkit, sysimage_path="build/EconomicToolkit.so")'
  artifacts:
    paths:
      - build/
    expire_in: 1 week
  only:
    - main
    - develop
    - tags

build:excel:
  stage: build
  image: node:${NODE_VERSION}
  needs: ["build:typescript"]
  script:
    - npm ci
    - npm run build:excel
    - cp dist/officejs/manifest.xml dist/officejs/
  artifacts:
    paths:
      - dist/officejs/
    expire_in: 1 week
  only:
    - main
    - develop
    - tags

build:libreoffice:
  stage: build
  image: node:${NODE_VERSION}
  needs: ["build:typescript"]
  script:
    - npm ci
    - npm run build:libre
    - cd dist/uno && zip -r economic-toolkit.oxt *
  artifacts:
    paths:
      - dist/uno/economic-toolkit.oxt
    expire_in: 1 week
  only:
    - main
    - develop
    - tags

build:container:
  stage: build
  image: quay.io/podman/stable
  script:
    - podman build -t economic-toolkit:${CI_COMMIT_SHORT_SHA} .
    - podman save economic-toolkit:${CI_COMMIT_SHORT_SHA} -o economic-toolkit.tar
  artifacts:
    paths:
      - economic-toolkit.tar
    expire_in: 1 week
  only:
    - main
    - develop
    - tags

# ===== SECURITY STAGE =====

security:dependency-scan:
  stage: security
  image: node:${NODE_VERSION}
  script:
    - npm audit --production
    - julia --project=. -e 'using Pkg; Pkg.audit()'
  allow_failure: true
  only:
    - merge_requests
    - main

security:sast:
  stage: security
  image: returntocorp/semgrep
  script:
    - semgrep --config=auto src/
  allow_failure: true
  only:
    - merge_requests
    - main

security:container-scan:
  stage: security
  image: aquasec/trivy:latest
  needs: ["build:container"]
  script:
    - trivy image --input economic-toolkit.tar
  allow_failure: true
  only:
    - main
    - tags

# ===== DEPLOY STAGE =====

deploy:registry:
  stage: deploy
  image: quay.io/podman/stable
  needs: ["build:container"]
  script:
    - podman load -i economic-toolkit.tar
    - podman tag economic-toolkit:${CI_COMMIT_SHORT_SHA} registry.gitlab.com/hyperpolymath/economic-toolkit:${CI_COMMIT_REF_NAME}
    - podman tag economic-toolkit:${CI_COMMIT_SHORT_SHA} registry.gitlab.com/hyperpolymath/economic-toolkit:latest
    - echo ${CI_REGISTRY_PASSWORD} | podman login -u ${CI_REGISTRY_USER} --password-stdin registry.gitlab.com
    - podman push registry.gitlab.com/hyperpolymath/economic-toolkit:${CI_COMMIT_REF_NAME}
    - podman push registry.gitlab.com/hyperpolymath/economic-toolkit:latest
  only:
    - main
    - tags

deploy:docs:
  stage: deploy
  image: julia:${JULIA_VERSION}
  script:
    - julia --project=docs docs/make.jl
  artifacts:
    paths:
      - docs/build/
  only:
    - main

# ===== RELEASE STAGE =====

release:gitlab:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs:
    - build:excel
    - build:libreoffice
    - build:container
  script:
    - echo "Creating GitLab release"
  release:
    tag_name: ${CI_COMMIT_TAG}
    description: 'Release ${CI_COMMIT_TAG}'
    assets:
      links:
        - name: 'Excel Add-in'
          url: '${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/file/dist/officejs/manifest.xml'
        - name: 'LibreOffice Extension'
          url: '${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/file/dist/uno/economic-toolkit.oxt'
        - name: 'Container Image'
          url: 'registry.gitlab.com/hyperpolymath/economic-toolkit:${CI_COMMIT_TAG}'
  only:
    - tags

# ===== QUALITY GATES =====

coverage:check:
  stage: test
  image: alpine:latest
  needs:
    - test:julia
    - test:typescript
  script:
    - echo "Checking coverage thresholds"
    - echo "Julia coverage should be >= 80%"
    - echo "TypeScript coverage should be >= 80%"
  only:
    - merge_requests
    - main
